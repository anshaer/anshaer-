<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡åˆ†å‰²å·¥å…·</title>
    <style>
        :root {
            --bg-dark: #121212;
            --panel-dark: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #b0b0b0;
            --primary: #3766f2;
            --accent: #ff3b30;
            --border: #333333;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main);
            margin: 0; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        .container { 
            background: var(--panel-dark); 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
            width: 100%; 
            max-width: 600px; 
            box-sizing: border-box; 
        }

        h2 { text-align: center; font-size: 1.4rem; margin-bottom: 25px; color: #fff; letter-spacing: 1px; }

        .control-group { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            background: rgba(255, 255, 255, 0.03); 
        }

        label { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); display: block; margin-bottom: 10px; text-transform: uppercase; }

        select, input[type="file"] { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: #2c2c2e; 
            color: #fff; 
            font-size: 16px; 
            outline: none;
        }

        .slider-box { margin: 18px 0; border-top: 1px solid var(--border); padding-top: 15px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .slider-header b { color: var(--primary); font-size: 1.1rem; }

        input[type="range"] { 
            width: 100%; 
            height: 8px; 
            background: #333; 
            border-radius: 4px; 
            outline: none; 
            accent-color: var(--primary);
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        .canvas-container { 
            position: relative; 
            width: 100%; 
            margin: 20px 0; 
            border-radius: 10px; 
            overflow: hidden; 
            border: 2px solid var(--border); 
            background: #000;
        }
        canvas { width: 100%; height: auto; display: block; }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .download-btn { 
            border: none; 
            padding: 14px; 
            border-radius: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 0.95rem; 
            transition: opacity 0.2s;
        }
        .download-btn:active { opacity: 0.7; }
        
        .single { background: #3a3a3c; color: #fff; }
        .all { background: var(--primary); color: white; grid-column: span 2; margin-top: 10px; font-size: 1.1rem; }

        .radio-group { 
            display: flex; 
            gap: 15px; 
            background: #2c2c2e; 
            padding: 12px; 
            border-radius: 10px; 
        }
        .radio-group label { margin: 0; font-weight: normal; display: flex; align-items: center; cursor: pointer; color: var(--text-main); }
        .radio-group input { margin-right: 6px; width: 18px; height: 18px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¨ åœ–ç‰‡æ¯”ä¾‹åˆ‡å‰² (æ·±è‰²ç‰ˆ)</h2>
    
    <div class="control-group">
        <label>1. ä¸Šå‚³èˆ‡æ ¼å¼</label>
        <input type="file" id="upload" accept="image/*">
        <select id="format">
            <option value="image/jpeg">JPEG (.jpg)</option>
            <option value="image/png">PNG (.png)</option>
            <option value="image/webp">WebP (.webp)</option>
        </select>
    </div>

    <div class="control-group">
        <label>2. åˆ‡å‰²æ¨¡å¼</label>
        <select id="splitMode">
            <option value="2">2 åˆ†æ³•</option>
            <option value="4">4 åˆ†æ³•</option>
        </select>
        <div class="radio-group">
            <label><input type="radio" name="dir" value="v" checked> ç¸±å‘</label>
            <label><input type="radio" name="dir" value="h"> æ©«å‘</label>
            <label id="crossOption" style="display:none;"><input type="radio" name="dir" value="c"> åå­—</label>
        </div>
    </div>

    <div id="ratioControls" class="control-group">
        <label>3. æ¯”ä¾‹èª¿æ•´</label>
        <div id="sliders"></div>
    </div>

    <div class="canvas-container">
        <canvas id="preview"></canvas>
    </div>

    <div id="singleDownloads" class="btn-grid"></div>
    <button id="allDownload" class="download-btn all">æ‰“åŒ…ä¸‹è¼‰å…¨éƒ¨ (.zip)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
    // é‚è¼¯éƒ¨åˆ†èˆ‡ä¹‹å‰ç›¸åŒï¼Œåƒ…åœ¨ draw() ä¸­å¾®èª¿äº†æ–‡å­—å¯è®€æ€§
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('preview');
    const ctx = canvas.getContext('2d');
    const slidersDiv = document.getElementById('sliders');
    const singleDownloads = document.getElementById('singleDownloads');
    
    let img = new Image();
    let originalName = "image";
    let config = { mode: '2', dir: 'v', ratios: [50] };
    let regions = [];

    upload.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        originalName = file.name.split('.').slice(0, -1).join('.');
        const reader = new FileReader();
        reader.onload = event => {
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                updateSliders();
                draw();
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    function updateSliders() {
        slidersDiv.innerHTML = '';
        let count = (config.mode === '2') ? 1 : (config.dir === 'c' ? 2 : 3);
        config.ratios = Array(count).fill(0).map((_, i) => Math.round((i + 1) * (100 / (count + 1))));
        
        config.ratios.forEach((r, i) => {
            const labelText = config.dir === 'c' ? (i===0 ? 'å‚ç›´ä½ç½® (X)' : 'æ°´å¹³ä½ç½® (Y)') : `åˆ‡å‰²ç·š ${i+1}`;
            const box = document.createElement('div');
            box.className = 'slider-box';
            box.innerHTML = `
                <div class="slider-header"><span>${labelText}</span><b id="val-${i}">${r}%</b></div>
                <input type="range" value="${r}" min="1" max="99">
            `;
            const slider = box.querySelector('input');
            slider.oninput = (e) => {
                config.ratios[i] = parseInt(e.target.value);
                document.getElementById(`val-${i}`).innerText = e.target.value + '%';
                draw();
            };
            slidersDiv.appendChild(box);
        });
    }

    function draw() {
        if (!img.src) return;
        ctx.drawImage(img, 0, 0);
        calculateRegions();

        // ç¹ªè£½ç·šæ¢
        ctx.strokeStyle = '#ff3b30'; // ä½¿ç”¨äº®ç´…è‰²
        ctx.lineWidth = Math.max(img.width * 0.006, 3);
        ctx.setLineDash([img.width * 0.02, img.width * 0.01]);
        
        const fontSize = Math.max(img.width * 0.06, 24);
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (config.dir === 'c') {
            const x = img.width * (config.ratios[0]/100);
            const y = img.height * (config.ratios[1]/100);
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, img.height); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(img.width, y); ctx.stroke();
        } else {
            config.ratios.forEach(r => {
                ctx.beginPath();
                if (config.dir === 'v') { ctx.moveTo(img.width * r/100, 0); ctx.lineTo(img.width * r/100, img.height); }
                else { ctx.moveTo(0, img.height * r/100); ctx.lineTo(img.width, img.height * r/100); }
                ctx.stroke();
            });
        }

        // ç·¨è™ŸèƒŒæ™¯
        regions.forEach((reg, i) => {
            const centerX = reg.x + reg.w/2;
            const centerY = reg.y + reg.h/2;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; // æ·±è‰²èƒŒæ™¯åœˆ
            ctx.beginPath();
            ctx.arc(centerX, centerY, fontSize * 0.8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff'; // ç™½è‰²æ–‡å­—
            ctx.fillText(i+1, centerX, centerY);
        });

        updateDownloadButtons();
    }

    function calculateRegions() {
        regions = [];
        const sortedRatios = [...config.ratios].sort((a,b) => a-b);
        if (config.dir === 'v') {
            let lastX = 0;
            [...sortedRatios, 100].forEach(p => {
                let x = (p/100)*img.width;
                regions.push({x: lastX, y: 0, w: x - lastX, h: img.height});
                lastX = x;
            });
        } else if (config.dir === 'h') {
            let lastY = 0;
            [...sortedRatios, 100].forEach(p => {
                let y = (p/100)*img.height;
                regions.push({x: 0, y: lastY, w: img.width, h: y - lastY});
                lastY = y;
            });
        } else if (config.dir === 'c') {
            const rx = config.ratios[0]/100, ry = config.ratios[1]/100;
            const w1 = img.width * rx, h1 = img.height * ry;
            regions = [
                {x:0, y:0, w:w1, h:h1}, {x:w1, y:0, w:img.width-w1, h:h1},
                {x:0, y:h1, w:w1, h:img.height-h1}, {x:w1, y:h1, w:img.width-w1, h:img.height-h1}
            ];
        }
    }

    function updateDownloadButtons() {
        singleDownloads.innerHTML = '';
        regions.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.className = 'download-btn single';
            btn.innerText = `ä¸‹è¼‰å€å¡Š ${i+1}`;
            btn.onclick = () => downloadPart(i);
            singleDownloads.appendChild(btn);
        });
    }

    async function downloadPart(index) {
        const reg = regions[index];
        const format = document.getElementById('format').value;
        const ext = format.split('/')[1].replace('jpeg', 'jpg');
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = reg.w;
        tempCanvas.height = reg.h;
        tempCanvas.getContext('2d').drawImage(img, reg.x, reg.y, reg.w, reg.h, 0, 0, reg.w, reg.h);
        const link = document.createElement('a');
        link.download = `${index + 1}_${originalName}.${ext}`;
        link.href = tempCanvas.toDataURL(format, 0.9);
        link.click();
    }

    document.getElementById('allDownload').onclick = async () => {
        if (!img.src) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡');
        const zip = new JSZip();
        const format = document.getElementById('format').value;
        const ext = format.split('/')[1].replace('jpeg', 'jpg');
        for(let i=0; i<regions.length; i++) {
            const reg = regions[i];
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = reg.w;
            tempCanvas.height = reg.h;
            tempCanvas.getContext('2d').drawImage(img, reg.x, reg.y, reg.w, reg.h, 0, 0, reg.w, reg.h);
            zip.file(`${i+1}_${originalName}.${ext}`, tempCanvas.toDataURL(format, 0.9).split(',')[1], {base64: true});
        }
        const content = await zip.generateAsync({type: "blob"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(content);
        link.download = `${originalName}_all.zip`;
        link.click();
    };

    document.getElementById('splitMode').onchange = e => {
        config.mode = e.target.value;
        document.getElementById('crossOption').style.display = config.mode === '4' ? 'inline' : 'none';
        if (config.mode === '2' && config.dir === 'c') {
            document.querySelector('input[value="v"]').checked = true;
            config.dir = 'v';
        }
        updateSliders();
        draw();
    };
    
    document.getElementsByName('dir').forEach(radio => {
        radio.onchange = e => {
            config.dir = e.target.value;
            updateSliders();
            draw();
        };
    });
</script>
</body>
</html>
