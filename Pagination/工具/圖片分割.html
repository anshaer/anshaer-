<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="tab-title">åœ–ç‰‡åˆ†å‰²</title>
    <style>
        /* å®šç¾©ä¸»é¡Œè®Šæ•¸ */
        :root { 
            --primary: #007bff; 
            --bg: #f8f9fa; 
            --card: #ffffff; 
            --text: #333333; 
            --border: #eeeeee;
            --slider-bg: #fafafa;
            --btn-single: #f1f3f5;
            --btn-single-text: #495057;
        }

        /* æ·±è‰²æ¨¡å¼è®Šæ•¸ */
        [data-theme="dark"] {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --border: #333333;
            --slider-bg: #2d2d2d;
            --btn-single: #333333;
            --btn-single-text: #cccccc;
        }

        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text);
            margin: 0; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; 
            transition: background 0.3s, color 0.3s;
        }

        .container { 
            background: var(--card); 
            padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            width: 100%; max-width: 600px; 
            box-sizing: border-box; position: relative; 
        }

        /* å·¥å…·æ¬„ï¼šèªè¨€èˆ‡ä¸»é¡Œ */
        .toolbar { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 100; }
        
        .icon-btn { 
            background: rgba(0,0,0,0.05); border: none; 
            padding: 6px 12px; border-radius: 20px; 
            cursor: pointer; font-size: 14px; color: var(--text); 
            display: flex; align-items: center; gap: 4px;
        }
        [data-theme="dark"] .icon-btn { background: rgba(255,255,255,0.1); }

        #langMenu { 
            display: none; position: absolute; top: 35px; right: 0; 
            background: var(--card); border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
            border: 1px solid var(--border); overflow: hidden; 
        }
        #langMenu div { padding: 10px 20px; cursor: pointer; font-size: 14px; white-space: nowrap; }
        #langMenu div:hover { background: var(--primary); color: white; }
        #langMenu.show { display: block; }

        h2 { font-size: 1.3rem; margin: 0 0 20px 0; }
        .control-group { margin-bottom: 15px; padding: 15px; border: 1px solid var(--border); border-radius: 10px; }
        label { font-size: 0.85rem; font-weight: bold; opacity: 0.8; display: block; margin-bottom: 10px; }
        
        select, input[type="file"] { 
            width: 100%; padding: 12px; margin-bottom: 10px; 
            border: 1px solid var(--border); border-radius: 8px; 
            font-size: 16px; background: var(--card); color: var(--text);
        }
        
        .slider-box { margin: 10px 0; padding-top: 10px; border-top: 1px solid var(--border); }
        .slider-header { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
        input[type="range"] { width: 100%; height: 35px; accent-color: var(--primary); }
        
        canvas { width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0; background: #eee; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .download-btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .single { background: var(--btn-single); color: var(--btn-single-text); font-size: 0.8rem; }
        .all { background: var(--primary); color: white; grid-column: span 2; margin-top: 10px; }
        
        .radio-group { display: flex; gap: 12px; padding: 10px; background: var(--slider-bg); border-radius: 8px; }
        .radio-group label { margin: 0; font-weight: normal; display: flex; align-items: center; gap: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="toolbar">
        <button id="themeBtn" class="icon-btn">ğŸŒ™</button>
        <div style="position:relative">
            <button id="langBtn" class="icon-btn">ğŸŒ</button>
            <div id="langMenu">
                <div onclick="changeLang('zh')">ç¹é«”ä¸­æ–‡</div>
                <div onclick="changeLang('en')">English</div>
                <div onclick="changeLang('ja')">æ—¥æœ¬èª</div>
            </div>
        </div>
    </div>

    <h2 id="ui-title">åœ–ç‰‡åˆ†å‰²</h2>
    
    <div class="control-group">
        <label id="label-step1">1. æª”æ¡ˆèˆ‡åŒ¯å‡ºæ ¼å¼</label>
        <input type="file" id="upload" accept="image/*">
        <select id="format">
            <option value="image/jpeg">JPEG (.jpg)</option>
            <option value="image/png">PNG (.png)</option>
            <option value="image/webp">WebP (.webp)</option>
        </select>
    </div>

    <div class="control-group">
        <label id="label-step2">2. åˆ‡å‰²æ–¹å¼</label>
        <select id="splitMode">
            <option value="2" id="opt-2cut">2 åˆ†æ³•</option>
            <option value="4" id="opt-4cut">4 åˆ†æ³•</option>
        </select>
        <div class="radio-group">
            <label><input type="radio" name="dir" value="v" checked> <span id="ui-v">ç¸±å‘</span></label>
            <label><input type="radio" name="dir" value="h"> <span id="ui-h">æ©«å‘</span></label>
            <label id="crossOption" style="display:none;"><input type="radio" name="dir" value="c"> <span id="ui-c">åå­—åˆ‡</span></label>
        </div>
    </div>

    <div id="ratioControls" class="control-group">
        <label id="label-step3">3. æ¯”ä¾‹èª¿æ•´</label>
        <div id="sliders"></div>
    </div>

    <canvas id="preview"></canvas>

    <div id="singleDownloads" class="btn-grid"></div>
    <button id="allDownload" class="download-btn all">æ‰“åŒ…ä¸‹è¼‰å…¨éƒ¨ (.zip)</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
    // --- èªè¨€èˆ‡ä¸»é¡Œé‚è¼¯ ---
    const i18n = {
        zh: { title: "åœ–ç‰‡åˆ†å‰²", step1: "1. æª”æ¡ˆèˆ‡åŒ¯å‡ºæ ¼å¼", step2: "2. åˆ‡å‰²æ–¹å¼", step3: "3. æ¯”ä¾‹èª¿æ•´", cut2: "2 åˆ†æ³•", cut4: "4 åˆ†æ³•", v: "ç¸±å‘", h: "æ©«å‘", c: "åå­—åˆ‡", ratioX: "å·¦å³æ¯”ä¾‹ (X)", ratioY: "ä¸Šä¸‹æ¯”ä¾‹ (Y)", cutLine: "åˆ‡å‰²ç·š", downSingle: "ä¸‹è¼‰å€å¡Š", downAll: "æ‰“åŒ…ä¸‹è¼‰å…¨éƒ¨ (.zip)", alertNoImg: "è«‹å…ˆä¸Šå‚³åœ–ç‰‡" },
        en: { title: "Image Splitter", step1: "1. File & Format", step2: "2. Mode", step3: "3. Adjust Ratios", cut2: "2-Way", cut4: "4-Way", v: "Vertical", h: "Horizontal", c: "Cross", ratioX: "Width (X)", ratioY: "Height (Y)", cutLine: "Line", downSingle: "Part", downAll: "Download All (.zip)", alertNoImg: "Please upload an image" },
        ja: { title: "ç”»åƒåˆ†å‰²", step1: "1. ãƒ•ã‚¡ã‚¤ãƒ«ã¨å½¢å¼", step2: "2. åˆ†å‰²ãƒ¢ãƒ¼ãƒ‰", step3: "3. æ¯”ç‡èª¿æ•´", cut2: "2åˆ†å‰²", cut4: "4åˆ†å‰²", v: "å‚ç›´", h: "æ°´å¹³", c: "åå­—", ratioX: "å·¦å³æ¯”ç‡ (X)", ratioY: "ä¸Šä¸‹æ¯”ç‡ (Y)", cutLine: "ç·š", downSingle: "åŒºç”»", downAll: "ã™ã¹ã¦ä¿å­˜ (.zip)", alertNoImg: "ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„" }
    };

    let currentLang = 'zh';
    let isDark = false;

    // ä¸»é¡Œåˆ‡æ›
    document.getElementById('themeBtn').onclick = () => {
        isDark = !isDark;
        document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        document.getElementById('themeBtn').innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    };

    // èªè¨€é¸å–®
    document.getElementById('langBtn').onclick = (e) => {
        e.stopPropagation();
        document.getElementById('langMenu').classList.toggle('show');
    };
    window.onclick = () => document.getElementById('langMenu').classList.remove('show');

    function changeLang(lang) {
        currentLang = lang;
        updateLanguage();
    }

    function updateLanguage() {
        const t = i18n[currentLang];
        document.getElementById('tab-title').innerText = t.title;
        document.getElementById('ui-title').innerText = t.title;
        document.getElementById('label-step1').innerText = t.step1;
        document.getElementById('label-step2').innerText = t.step2;
        document.getElementById('label-step3').innerText = t.step3;
        document.getElementById('opt-2cut').innerText = t.cut2;
        document.getElementById('opt-4cut').innerText = t.cut4;
        document.getElementById('ui-v').innerText = t.v;
        document.getElementById('ui-h').innerText = t.h;
        document.getElementById('ui-c').innerText = t.c;
        document.getElementById('allDownload').innerText = t.downAll;
        updateSliders();
        draw();
    }

    // --- æ ¸å¿ƒè™•ç†é‚è¼¯ ---
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('preview');
    const ctx = canvas.getContext('2d');
    const slidersDiv = document.getElementById('sliders');
    const singleDownloads = document.getElementById('singleDownloads');
    
    let img = new Image();
    let originalName = "image";
    let config = { mode: '2', dir: 'v', ratios: [50] };
    let regions = [];

    upload.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        originalName = file.name.split('.').slice(0, -1).join('.');
        const reader = new FileReader();
        reader.onload = ev => {
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                updateSliders(); draw();
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    function updateSliders() {
        slidersDiv.innerHTML = '';
        let count = (config.mode === '2') ? 1 : (config.dir === 'c' ? 2 : 3);
        if (config.ratios.length !== count) config.ratios = Array(count).fill(0).map((_, i) => Math.round((i + 1) * (100 / (count + 1))));
        const t = i18n[currentLang];
        config.ratios.forEach((r, i) => {
            let labelText = config.dir === 'c' ? (i===0 ? t.ratioX : t.ratioY) : `${t.cutLine} ${i+1}`;
            const box = document.createElement('div');
            box.className = 'slider-box';
            box.innerHTML = `<div class="slider-header"><span>${labelText}</span><b>${r}%</b></div><input type="range" value="${r}" min="1" max="99">`;
            box.querySelector('input').oninput = (e) => {
                config.ratios[i] = parseInt(e.target.value);
                box.querySelector('b').innerText = e.target.value + '%';
                draw();
            };
            slidersDiv.appendChild(box);
        });
    }

    function draw() {
        if (!img.src) return;
        ctx.drawImage(img, 0, 0);
        calculateRegions();
        ctx.strokeStyle = 'red';
        ctx.lineWidth = Math.max(img.width * 0.006, 2);
        ctx.setLineDash([15, 10]);
        const fontSize = Math.max(img.width * 0.05, 18);
        ctx.font = `bold ${fontSize}px sans-serif`;
        ctx.textAlign = 'center';

        if (config.dir === 'c') {
            const x = img.width * (config.ratios[0]/100), y = img.height * (config.ratios[1]/100);
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, img.height); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(img.width, y); ctx.stroke();
        } else {
            config.ratios.forEach(r => {
                ctx.beginPath();
                if (config.dir === 'v') { ctx.moveTo(img.width * r/100, 0); ctx.lineTo(img.width * r/100, img.height); }
                else { ctx.moveTo(0, img.height * r/100); ctx.lineTo(img.width, img.height * r/100); }
                ctx.stroke();
            });
        }
        regions.forEach((reg, i) => {
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.beginPath(); ctx.arc(reg.x+reg.w/2, reg.y+reg.h/2, fontSize, 0, 7); ctx.fill();
            ctx.fillStyle = 'red';
            ctx.fillText(i+1, reg.x+reg.w/2, reg.y+reg.h/2 + fontSize/3);
        });
        updateDownloadButtons();
    }

    function calculateRegions() {
        regions = [];
        const sorted = [...config.ratios].sort((a,b)=>a-b);
        if (config.dir === 'v') {
            let lastX = 0;
            [...sorted, 100].forEach(p => {
                let x = (p/100)*img.width;
                regions.push({x: lastX, y: 0, w: x-lastX, h: img.height});
                lastX = x;
            });
        } else if (config.dir === 'h') {
            let lastY = 0;
            [...sorted, 100].forEach(p => {
                let y = (p/100)*img.height;
                regions.push({x: 0, y: lastY, w: img.width, h: y-lastY});
                lastY = y;
            });
        } else if (config.dir === 'c') {
            const rx = config.ratios[0]/100, ry = config.ratios[1]/100;
            const w1 = img.width*rx, h1 = img.height*ry;
            regions = [{x:0, y:0, w:w1, h:h1}, {x:w1, y:0, w:img.width-w1, h:h1}, {x:0, y:h1, w:w1, h:img.height-h1}, {x:w1, y:h1, w:img.width-w1, h:img.height-h1}];
        }
    }

    function updateDownloadButtons() {
        singleDownloads.innerHTML = '';
        const t = i18n[currentLang];
        regions.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.className = 'download-btn single';
            btn.innerText = `${t.downSingle} ${i+1}`;
            btn.onclick = () => downloadPart(i);
            singleDownloads.appendChild(btn);
        });
    }

    async function downloadPart(idx) {
        const reg = regions[idx];
        const format = document.getElementById('format').value;
        const ext = format.split('/')[1].replace('jpeg', 'jpg');
        const temp = document.createElement('canvas');
        temp.width = reg.w; temp.height = reg.h;
        temp.getContext('2d').drawImage(img, reg.x, reg.y, reg.w, reg.h, 0, 0, reg.w, reg.h);
        const a = document.createElement('a');
        a.download = `${idx+1}_${originalName}.${ext}`;
        a.href = temp.toDataURL(format, 0.9);
        a.click();
    }

    document.getElementById('allDownload').onclick = async () => {
        if (!img.src) return alert(i18n[currentLang].alertNoImg);
        const zip = new JSZip();
        const format = document.getElementById('format').value;
        const ext = format.split('/')[1].replace('jpeg', 'jpg');
        for(let i=0; i<regions.length; i++){
            const reg = regions[i];
            const temp = document.createElement('canvas');
            temp.width = reg.w; temp.height = reg.h;
            temp.getContext('2d').drawImage(img, reg.x, reg.y, reg.w, reg.h, 0, 0, reg.w, reg.h);
            zip.file(`${i+1}_${originalName}.${ext}`, temp.toDataURL(format, 0.9).split(',')[1], {base64: true});
        }
        const blob = await zip.generateAsync({type:"blob"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${originalName}_split.zip`;
        a.click();
    };

    document.getElementById('splitMode').onchange = e => {
        config.mode = e.target.value;
        document.getElementById('crossOption').style.display = config.mode === '4' ? 'inline' : 'none';
        if (config.mode === '2' && config.dir === 'c') { document.querySelector('input[value="v"]').checked = true; config.dir = 'v'; }
        updateSliders(); draw();
    };
    
    document.getElementsByName('dir').forEach(radio => {
        radio.onchange = e => { config.dir = e.target.value; updateSliders(); draw(); };
    });

    updateLanguage();
</script>
</body>
</html>
