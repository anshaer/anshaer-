<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–è¦ºå°æŠ—èˆ‡å½±ç‰‡ç”Ÿæˆå·¥å…·</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <style>
        :root {
            --primary-color: #007AFF;
            --secondary-color: #9b59b6;
            --bg-dark: #1a1a1a;
            --panel-bg: #2c2c2c;
            --text-light: #eee;
        }

        body {
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container { width: 100%; max-width: 900px; }
        h1 { text-align: center; color: var(--primary-color); }

        /* å€å¡Šæ¨£å¼ */
        .tool-section {
            background: var(--panel-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .section-header {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ç¬¬ä¸€å€å¡Šï¼šé®ç½©è¨­å®š */
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .full-width { grid-column: span 2; }
        
        input[type="range"] { width: 100%; accent-color: var(--primary-color); }
        input[type="text"], select { 
            width: 100%; padding: 10px; border-radius: 6px; 
            background: #444; border: 1px solid #666; color: white; 
        }

        canvas { 
            width: 100%; max-height: 500px; object-fit: contain;
            background-image: linear-gradient(45deg, #222 25%, transparent 25%), linear-gradient(-45deg, #222 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #222 75%), linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px; border: 2px solid #555; margin-top: 15px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 12px 20px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-sync { background: #f39c12; color: white; margin-top: 10px; width: 100%; }

        /* å½±ç‰‡é è¦½ */
        #videoPreview { width: 100%; border-radius: 12px; margin-top: 15px; background: #000; display: none; }
        
        .status { text-align: center; margin: 10px 0; color: var(--primary-color); font-weight: 500; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¨ å¤šåª’é«”é˜²è­·å·¥ä½œç«™</h1>

    <div class="tool-section">
        <div class="section-header">1. åœ–åƒé®ç½©èˆ‡å¹²æ“¾è¨­è¨ˆ</div>
        <div class="controls-grid">
            <div class="full-width">
                <label>ä¸Šå‚³åº•åœ–ï¼š</label>
                <input type="file" id="upload" accept="image/*">
            </div>
            <div class="full-width" style="background: #3d3d3d; padding: 10px; border-radius: 8px;">
                <label>é¡¯ç¤ºæ¨¡å¼ï¼š</label>
                <input type="radio" name="displayPos" id="posBoard" value="board" checked> åœ–ç‰‡åœ¨åº•åº§
                <input type="radio" name="displayPos" id="posHole" value="hole"> åœ–ç‰‡åœ¨å­”æ´
            </div>
            <div>
                <label>ç¬¦è™Ÿå¤§å°: <span id="val-radius">25</span></label>
                <input type="range" id="radius" min="10" max="100" value="25">
            </div>
            <div>
                <label>åˆ†å¸ƒå¯†åº¦: <span id="val-spacing">40</span></label>
                <input type="range" id="spacing" min="15" max="150" value="40">
            </div>
            <div class="full-width">
                <label>å¹²æ“¾æ–‡å­—ï¼š</label>
                <input type="text" id="overlayText" placeholder="è¼¸å…¥æ–‡å­—...">
            </div>
            <div class="full-width">
                <button id="re-random" class="btn btn-primary" style="width:100%">éš¨æ©Ÿæ‰“äº‚ç¬¦è™Ÿ</button>
                <button id="syncToVideo" class="btn btn-sync">â¬‡ï¸ å°‡æ­¤è¨­è¨ˆå‚³é€åˆ°å½±ç‰‡å·¥å…·</button>
            </div>
        </div>
        <canvas id="canvas"></canvas>
    </div>

    <div class="tool-section" id="video-section">
        <div class="section-header">2. å½±ç‰‡æµ®æ°´å°è½‰æ› (3ç§’)</div>
        <div class="controls-grid">
            <div class="full-width">
                <label>å½±ç‰‡æµ®æ°´å°æ–‡å­—ï¼š</label>
                <input type="text" id="videoText" value="ç¦æ­¢ç›œç”¨">
            </div>
            <div>
                <label>æ–‡å­—å¤§å°ï¼š<span id="val-videoFontSize">80</span></label>
                <input type="range" id="videoFontSize" min="20" max="250" value="80">
            </div>
            <div>
                <label>è¼¸å‡ºç•«è³ªï¼š</label>
                <select id="qualitySelect">
                    <option value="480">480p</option>
                    <option value="720" selected>720p</option>
                    <option value="1080">1080p</option>
                </select>
            </div>
            <div class="full-width">
                <button id="convertBtn" class="btn btn-success" style="width:100%">ç”Ÿæˆ 3 ç§’å½±ç‰‡</button>
                <div id="statusDisplay" class="status">ç­‰å¾…åœ–ç‰‡è¼¸å…¥...</div>
            </div>
        </div>

        <video id="videoPreview" controls></video>
        <div id="actionButtons" style="display:none; margin-top: 15px; text-align: center;">
            <a id="downloadLink" class="btn btn-primary" style="text-decoration: none;">ä¸‹è¼‰å½±ç‰‡</a>
        </div>
    </div>
</div>

<script>
    // --- å…±ç”¨èˆ‡åˆå§‹åŒ– ---
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: false });
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();
    let syncedBlob = null; // ç”¨æ–¼å­˜å„²å¾ç¬¬ä¸€å€å¡Šå‚³éä¾†çš„åœ–ç‰‡æ•¸æ“š

    const shapes = ['â– ','â—','âœ–','â›°ï¸','â¬†ï¸','â¬‡ï¸','âœš','âœ¦','â™¥','âš¡ï¸'];

    // --- ç¬¬ä¸€å€å¡Šé‚è¼¯ï¼šé®ç½©ç¹ªè£½ ---
    document.getElementById('upload').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (f) => {
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                draw();
            };
            img.src = f.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    function draw() {
        if (!img.src) return;
        const sRadius = parseInt(document.getElementById('radius').value);
        const sSpacing = parseInt(document.getElementById('spacing').value);
        const txt = document.getElementById('overlayText').value;
        let displayPos = document.querySelector('input[name="displayPos"]:checked').value;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (displayPos === 'board') {
            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(img, 0, 0);
            ctx.globalCompositeOperation = 'destination-out';
            drawSymbols(sRadius, sSpacing);
        } else {
            ctx.globalCompositeOperation = 'source-over';
            drawSymbols(sRadius, sSpacing);
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(img, 0, 0);
        }

        // æ–‡å­—å±¤
        ctx.globalCompositeOperation = 'source-over';
        if (txt) {
            ctx.font = `bold ${canvas.width/10}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 5;
            ctx.strokeText(txt, canvas.width/2, canvas.height/2);
            ctx.fillText(txt, canvas.width/2, canvas.height/2);
        }
    }

    function drawSymbols(sRadius, sSpacing) {
        ctx.font = `${sRadius}px sans-serif`;
        ctx.textAlign = 'center';
        for (let y = 0; y < canvas.height + sSpacing; y += sSpacing) {
            for (let x = 0; x < canvas.width + sSpacing; x += sSpacing) {
                ctx.save();
                ctx.translate(x + (Math.random()-0.5)*20, y + (Math.random()-0.5)*20);
                ctx.rotate(Math.random() * Math.PI);
                ctx.fillText(shapes[Math.floor(Math.random()*shapes.length)], 0, 0);
                ctx.restore();
            }
        }
    }

    // --- è¯å‹•åŠŸèƒ½ï¼šåŒæ­¥åœ–ç‰‡ ---
    document.getElementById('syncToVideo').onclick = () => {
        if (!img.src) return alert('è«‹å…ˆè£½ä½œä¸€å¼µé®ç½©åœ–ç‰‡');
        canvas.toBlob((blob) => {
            syncedBlob = blob;
            document.getElementById('statusDisplay').innerText = 'âœ… åœ–ç‰‡å·²åŒæ­¥ï¼å¯ä»¥é–‹å§‹ç”Ÿæˆå½±ç‰‡ã€‚';
            document.getElementById('video-section').scrollIntoView({ behavior: 'smooth' });
        }, 'image/png');
    };

    // --- ç¬¬äºŒå€å¡Šé‚è¼¯ï¼šå½±ç‰‡ç”Ÿæˆ ---
    document.getElementById('convertBtn').onclick = async () => {
        if (!syncedBlob) return alert('è«‹å…ˆé»æ“Šä¸Šæ–¹ã€Œå‚³é€åˆ°å½±ç‰‡å·¥å…·ã€æŒ‰éˆ•');
        
        const btn = document.getElementById('convertBtn');
        const status = document.getElementById('statusDisplay');
        const videoText = document.getElementById('videoText').value;
        const fontSize = document.getElementById('videoFontSize').value;
        const quality = document.getElementById('qualitySelect').value;

        btn.disabled = true;
        try {
            if (!ffmpeg.isLoaded()) {
                status.innerText = 'â³ å¼•æ“åˆå§‹åŒ–ä¸­...';
                await ffmpeg.load();
            }

            status.innerText = 'ğŸš€ å½±ç‰‡åˆæˆä¸­...';
            
            // å¯«å…¥æª”æ¡ˆ
            ffmpeg.FS('writeFile', 'input.png', await fetchFile(syncedBlob));
            
            // åŸ·è¡Œ FFmpeg (ç°¡å–®æµ®æ°´å°èˆ‡ç¸®æ”¾)
            await ffmpeg.run(
                '-loop', '1', '-i', 'input.png',
                '-t', '3',
                '-vf', `scale=-2:${quality},drawtext=text='${videoText}':fontcolor=white@0.5:fontsize=${fontSize}:x=(w-tw)/2:y=(h-th)/2`,
                '-pix_fmt', 'yuv420p',
                'out.mp4'
            );

            const data = ffmpeg.FS('readFile', 'out.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
            
            const v = document.getElementById('videoPreview');
            v.src = url;
            v.style.display = 'block';
            
            const dl = document.getElementById('downloadLink');
            dl.href = url;
            dl.download = `protected_video.mp4`;
            document.getElementById('actionButtons').style.display = 'block';
            
            status.innerText = 'âœ… å½±ç‰‡ç”Ÿæˆå®Œç•¢ï¼';
        } catch (e) {
            console.error(e);
            status.innerText = 'âŒ ç™¼ç”ŸéŒ¯èª¤ã€‚';
        } finally {
            btn.disabled = false;
        }
    };

    // UI æ•¸å€¼æ›´æ–°
    ['radius', 'spacing', 'videoFontSize'].forEach(id => {
        document.getElementById(id).oninput = (e) => {
            document.getElementById(`val-${id}`).innerText = e.target.value;
            if (id !== 'videoFontSize') draw();
        };
    });
    document.getElementById('re-random').onclick = draw;
    document.querySelectorAll('input[name="displayPos"]').forEach(r => r.onchange = draw);
    document.getElementById('overlayText').oninput = draw;

</script>

</body>
</html>
