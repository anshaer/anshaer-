<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS æ¸¬é€Ÿæ¸¬è©¦ (æ¥µç«¯å„ªåŒ–)</title>
    <style>
        /* åŸºç¤è¨­å®šèˆ‡æ·±å¤œæ¨¡å¼é…è‰² */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212; /* æ·±å¤œèƒŒæ™¯ */
            color: #e0e0e0; /* æ·ºè‰²æ–‡å­— */
            text-align: center;
        }
        
        /* å®¹å™¨èˆ‡ç‰ˆé¢ */
        .container {
            padding: 20px;
            max-width: 420px; /* æ¨¡æ“¬æ‰‹æ©Ÿå¯¬åº¦ */
            margin: 0 auto;
        }

        /* æ¨™é¡Œ */
        h1 {
            color: #00bcd4; /* é†’ç›®è—è‰² */
            font-size: 1.8em;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        /* é€Ÿåº¦é¡¯ç¤ºå€ */
        #speed-section {
            background-color: #1e1e1e;
            padding: 30px 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        
        /* æ™‚é€Ÿé¡¯ç¤ºï¼ˆå¤§å­—ï¼‰ */
        .speed-display {
            font-size: 5em;
            font-weight: 700;
            color: #4caf50; /* ç¶ è‰²ï¼Œè¡¨ç¤ºé‹è¡Œæ­£å¸¸ */
            display: block;
            line-height: 1.1;
        }
        
        .speed-display.stopped {
            color: #ff9800; /* æ©˜è‰²ï¼Œè¡¨ç¤ºå·²éœæ­¢/ä½é€Ÿ */
        }
        
        /* ä½é€Ÿæç¤ºç‡ˆ */
        #status-light {
            font-size: 2em;
            margin-bottom: 10px;
            height: 30px; 
        }

        /* è©³ç´°è³‡è¨Šå€ (å°å­—) */
        #details {
            text-align: left;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #333;
            font-size: 0.9em;
        }

        .detail-item {
            margin-bottom: 8px;
        }
        .detail-label {
            color: #9e9e9e; 
            width: 120px;
            display: inline-block;
        }
        .detail-value {
            color: #e0e0e0;
            font-weight: bold;
        }

        /* æŒ‰éˆ•å€ */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex-grow: 1;
            padding: 15px 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #startBtn {
            background-color: #4caf50;
            color: white;
        }
        #stopBtn {
            background-color: #f44336;
            color: white;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>GPS æ¸¬é€Ÿæ¸¬è©¦</h1>

        <div id="speed-section">
            <div id="status-light"></div>
            
            <span class="speed-display">--.- km/h</span>

            <div id="details">
                <div class="detail-item"><span class="detail-label">è¨ˆç®—æ™‚é€Ÿ (åŸå§‹)ï¼š</span><span id="calc-speed" class="detail-value">--.- km/h</span></div>
                <div class="detail-item"><span class="detail-label">å®šä½ç²¾åº¦ï¼š</span><span id="accuracy-value" class="detail-value">--.- å…¬å°º</span></div>
                <div class="detail-item"><span class="detail-label">è¨Šè™Ÿä¾†æºï¼š</span><span id="source-value" class="detail-value">N/A</span></div>
                <div class="detail-item"><span class="detail-label">ç•¶å‰ä½ç½®ï¼š</span><span id="location-value" class="detail-value">N/A</span></div>
            </div>
        </div>

        <div class="button-group">
            <button id="startBtn" onclick="startTracking()">é–‹å§‹è¿½è¹¤</button>
            <button id="stopBtn" onclick="stopTracking()" disabled>åœæ­¢è¿½è¹¤</button>
        </div>
    </div>

    <script>
        let watchID;
        let lastPosition = null;
        let smoothedSpeed_m_s = 0;

        // --- é…ç½®åƒæ•¸ ---
        const SMOOTHING_FACTOR = 0.2;       // å¹³æ»‘ä¿‚æ•¸ Î± (ç”¨æ–¼ > 3.0 km/h)
        const SMOOTHING_FACTOR_LOW = 0.5;   // è¼ƒé«˜å¹³æ»‘ä¿‚æ•¸ (ç”¨æ–¼ 0.2 ~ 3.0 km/h éæ¸¡å€é–“)
        const ZERO_THRESHOLD_KMH = 0.2;     // æ¥µé™éœæ­¢åˆ¤æ–·é–¾å€¼ (km/h)
        const HIGH_SPEED_THRESHOLD_KMH = 3.0; // å¿«é€Ÿç§»å‹•åˆ¤æ–·é–¾å€¼ (km/h)
        const EARTH_RADIUS_M = 6371000;
        // ------------------

        // æ•¸å­¸å‡½å¼ï¼šå°‡è§’åº¦è½‰ç‚ºå¼§åº¦
        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }

        // æ•¸å­¸å‡½å¼ï¼šè¨ˆç®—å…©é»ä¹‹é–“çš„çƒé¢è·é›¢ (Haversine å…¬å¼)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = EARTH_RADIUS_M; 
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // æ ¸å¿ƒé‚è¼¯ï¼šæˆåŠŸç²å–ä½ç½®æ™‚åŸ·è¡Œ
        function success(position) {
            const currentPosition = position;
            let calculatedSpeed_m_s = 0;
            let speedSource = "è¨ˆç®—å€¼ (Haversine)";

            // 1. å˜—è©¦ä½¿ç”¨ Geolocation API å…§å»ºçš„ speed å±¬æ€§
            if (currentPosition.coords.speed !== null && currentPosition.coords.speed >= 0) {
                calculatedSpeed_m_s = currentPosition.coords.speed;
                speedSource = "å…§å»ºå€¼ (è£ç½® GPS)";
            } 
            // 2. å¦‚æœæ²’æœ‰å…§å»º speedï¼Œå‰‡æ‰‹å‹•è¨ˆç®—
            else if (lastPosition) {
                const distance = getDistance(
                    lastPosition.coords.latitude, lastPosition.coords.longitude,
                    currentPosition.coords.latitude, currentPosition.coords.longitude
                );
                
                const timeDiff_s = (currentPosition.timestamp - lastPosition.timestamp) / 1000;

                if (timeDiff_s > 0.5) {
                    calculatedSpeed_m_s = distance / timeDiff_s;
                }
            }

            const calculatedSpeed_kmh = calculatedSpeed_m_s * 3.6;

            let speed_kmh;
            let displayClass = "";
            let statusLight = "ğŸ”´"; // é è¨­ç‚ºç§»å‹•/è®Šå‹•ç‹€æ…‹
            let smoothingAlpha = SMOOTHING_FACTOR; // é è¨­ä½¿ç”¨è¼ƒå° alpha (å¼·å¹³æ»‘)

            // ===========================================
            // 3. æ¥µç«¯åŒ–é€Ÿåº¦åˆ¤æ–·èˆ‡å¹³æ»‘é‚è¼¯
            // ===========================================
            if (calculatedSpeed_kmh <= ZERO_THRESHOLD_KMH) {
                // å€é–“ 1: æ¥µä½é€Ÿ (<= 0.2 km/h) -> ç›´æ¥æ­¸é›¶
                smoothedSpeed_m_s = 0;
                speed_kmh = 0.0;
                displayClass = "stopped";
                statusLight = "ğŸŸ¢"; // éœæ­¢é¡¯ç¤ºç¶ ç‡ˆ
            } else {
                // å€é–“ 2 & 3: ç§»å‹•æˆ–éæ¸¡

                if (calculatedSpeed_kmh <= HIGH_SPEED_THRESHOLD_KMH) {
                     // å€é–“ 2: éæ¸¡å€é–“ (0.2 < V <= 3.0 km/h)
                     // ä½¿ç”¨è¼ƒå¤§çš„å¹³æ»‘ä¿‚æ•¸ï¼Œè®“é€Ÿåº¦æ›´å¿«åœ°æ­¸é›¶ï¼Œä½†åˆä¸æœƒåœ¨å¾®å°ç§»å‹•æ™‚è·³å‹•
                     smoothingAlpha = SMOOTHING_FACTOR_LOW; 
                } else {
                    // å€é–“ 3: å¿«é€Ÿç§»å‹• (> 3.0 km/h)
                    // ä½¿ç”¨é è¨­çš„å°å¹³æ»‘ä¿‚æ•¸ï¼Œç¢ºä¿é«˜é€Ÿç©©å®š
                    smoothingAlpha = SMOOTHING_FACTOR;
                }

                // é€²è¡ŒæŒ‡æ•¸åŠ æ¬Šå¹³æ»‘è™•ç†
                smoothedSpeed_m_s = (smoothingAlpha * calculatedSpeed_m_s) + 
                                    ((1 - smoothingAlpha) * smoothedSpeed_m_s);
                speed_kmh = smoothedSpeed_m_s * 3.6;
            }
            // ===========================================

            // 4. æ›´æ–°ä»‹é¢å…ƒç´ 
            const speedDisplay = document.querySelector('.speed-display');
            speedDisplay.textContent = `${speed_kmh.toFixed(1)} km/h`;
            speedDisplay.className = `speed-display ${displayClass}`;

            document.getElementById('status-light').textContent = statusLight;
            document.getElementById('calc-speed').textContent = `${calculatedSpeed_kmh.toFixed(1)} km/h (Î±:${smoothingAlpha.toFixed(2)})`;
            document.getElementById('accuracy-value').textContent = `${currentPosition.coords.accuracy.toFixed(1)} å…¬å°º`;
            document.getElementById('source-value').textContent = speedSource;
            document.getElementById('location-value').textContent = `${currentPosition.coords.latitude.toFixed(4)}, ${currentPosition.coords.longitude.toFixed(4)}`;
            
            // 5. æ›´æ–°ä¸Šä¸€ç­†è³‡æ–™
            lastPosition = currentPosition;
        }

        // éŒ¯èª¤è™•ç†
        function error(err) {
            let errorMessage = "N/A";
            switch(err.code) {
                case err.PERMISSION_DENIED:
                    errorMessage = "æ‹’çµ•æˆæ¬Š (è«‹å…è¨±å­˜å–)";
                    break;
                case err.POSITION_UNAVAILABLE:
                    errorMessage = "è¨Šè™Ÿä¸å¯ç”¨";
                    break;
                case err.TIMEOUT:
                    errorMessage = "å®šä½è¶…æ™‚";
                    break;
                default:
                    errorMessage = "æœªçŸ¥éŒ¯èª¤";
            }
            
            // æ›´æ–°ä»‹é¢ç‚ºéŒ¯èª¤ç‹€æ…‹
            document.querySelector('.speed-display').textContent = "ERROR";
            document.getElementById('status-light').textContent = "âŒ";
            document.getElementById('source-value').textContent = errorMessage;
            
            stopTracking();
        }

        // é–‹å§‹æŒçºŒè¿½è¹¤
        function startTracking() {
            if (!navigator.geolocation) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½ APIã€‚");
                return;
            }

            document.getElementById("startBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;

            document.querySelector('.speed-display').textContent = "å®šä½ä¸­...";
            document.getElementById('status-light').textContent = "";
            document.getElementById('calc-speed').textContent = "--.- km/h";
            document.getElementById('accuracy-value').textContent = "--.- å…¬å°º";
            document.getElementById('source-value').textContent = "ç­‰å¾…è¨Šè™Ÿ...";
            document.getElementById('location-value').textContent = "N/A";

            lastPosition = null; 
            smoothedSpeed_m_s = 0; 

            watchID = navigator.geolocation.watchPosition(success, error, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }

        // åœæ­¢æŒçºŒè¿½è¹¤
        function stopTracking() {
            if (watchID !== undefined) {
                navigator.geolocation.clearWatch(watchID);
                watchID = undefined;
                document.getElementById("startBtn").disabled = false;
                document.getElementById("stopBtn").disabled = true;

                document.querySelector('.speed-display').textContent = "å·²åœæ­¢";
                document.getElementById('status-light').textContent = "â¸ï¸";
            }
        }
    </script>

</body>
</html>
