<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS æ¸¬é€Ÿæ¸¬è©¦ (å–®ä½åˆ‡æ›)</title>
    <style>
        /* åŸºç¤è¨­å®šèˆ‡æ·±å¤œæ¨¡å¼é…è‰² (æ²¿ç”¨ V3) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #e0e0e0;
            text-align: center;
        }
        .container {
            padding: 20px;
            max-width: 420px;
            margin: 0 auto;
        }
        h1 {
            color: #00bcd4;
            font-size: 1.8em;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        #speed-section {
            background-color: #1e1e1e;
            padding: 30px 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        .speed-display {
            font-size: 5em;
            font-weight: 700;
            color: #4caf50;
            display: block;
            line-height: 1.1;
        }
        .speed-display.stopped {
            color: #ff9800;
        }
        #status-light {
            font-size: 2em;
            margin-bottom: 10px;
            height: 30px; 
        }
        #details {
            text-align: left;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #333;
            font-size: 0.9em;
        }
        .detail-item { margin-bottom: 8px; }
        .detail-label {
            color: #9e9e9e; 
            width: 120px;
            display: inline-block;
        }
        .detail-value {
            color: #e0e0e0;
            font-weight: bold;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            flex-grow: 1;
            padding: 15px 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s, opacity 0.3s;
            font-weight: bold;
        }
        #startBtn {
            background-color: #4caf50;
            color: white;
        }
        #stopBtn {
            background-color: #f44336;
            color: white;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å–®ä½åˆ‡æ›æ¨£å¼ */
        #unit-selector {
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .radio-item {
            display: inline-flex;
            align-items: center;
            margin: 0 10px;
            cursor: pointer;
            font-size: 0.95em;
        }
        .radio-item input[type="radio"] {
            margin-right: 5px;
            accent-color: #00bcd4; /* è¨­å®šåœ“åœˆé¡è‰² */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>GPS æ¸¬é€Ÿæ¸¬è©¦</h1>

        <div id="unit-selector">
            <div class="radio-item">
                <input type="radio" id="unit_kmh" name="speed_unit" value="km/h" checked onchange="updateDisplayUnit()">
                <label for="unit_kmh">å…¬é‡Œ/æ™‚</label>
            </div>
            <div class="radio-item">
                <input type="radio" id="unit_mph" name="speed_unit" value="mph" onchange="updateDisplayUnit()">
                <label for="unit_mph">è‹±é‡Œ/æ™‚</label>
            </div>
            <div class="radio-item">
                <input type="radio" id="unit_kn" name="speed_unit" value="kn" onchange="updateDisplayUnit()">
                <label for="unit_kn">ç¯€ (æµ·é‡Œ/æ™‚)</label>
            </div>
        </div>

        <div id="speed-section">
            <div id="status-light"></div>
            
            <span class="speed-display">--.- km/h</span>

            <div id="details">
                <div class="detail-item"><span class="detail-label">è¨ˆç®—æ™‚é€Ÿ (åŸå§‹)ï¼š</span><span id="calc-speed" class="detail-value">--.- km/h</span></div>
                <div class="detail-item"><span class="detail-label">å®šä½ç²¾åº¦ï¼š</span><span id="accuracy-value" class="detail-value">--.- å…¬å°º</span></div>
                <div class="detail-item"><span class="detail-label">è¨Šè™Ÿä¾†æºï¼š</span><span id="source-value" class="detail-value">N/A</span></div>
                <div class="detail-item"><span class="detail-label">ç•¶å‰ä½ç½®ï¼š</span><span id="location-value" class="detail-value">N/A</span></div>
            </div>
        </div>

        <div class="button-group">
            <button id="startBtn" onclick="startTracking()">é–‹å§‹è¿½è¹¤</button>
            <button id="stopBtn" onclick="stopTracking()" disabled>åœæ­¢è¿½è¹¤</button>
        </div>
    </div>

    <script>
        let watchID;
        let lastPosition = null;
        let smoothedSpeed_m_s = 0; // åŸºç¤å–®ä½ (ç±³/ç§’)
        
        // --- é…ç½®åƒæ•¸ (æ²¿ç”¨ V3) ---
        const SMOOTHING_FACTOR = 0.2;
        const SMOOTHING_FACTOR_LOW = 0.5;
        const ZERO_THRESHOLD_KMH = 0.2;
        const HIGH_SPEED_THRESHOLD_KMH = 3.0;
        const EARTH_RADIUS_M = 6371000;
        // ------------------

        // --- å–®ä½è½‰æ›å¸¸æ•¸ (å¾ m/s è½‰æ›ç‚ºç›®æ¨™å–®ä½) ---
        const CONVERSION_FACTORS = {
            'km/h': 3.6,        // m/s * 3.6 = km/h
            'mph': 2.23694,     // m/s * 2.23694 = mph
            'kn': 1.94384      // m/s * 1.94384 = ç¯€ (knots)
        };
        // ------------------
        
        // æ•¸å­¸å‡½å¼ï¼šå°‡è§’åº¦è½‰ç‚ºå¼§åº¦ (ç•¥)
        function toRad(degrees) { return degrees * Math.PI / 180; }

        // æ•¸å­¸å‡½å¼ï¼šè¨ˆç®—å…©é»ä¹‹é–“çš„çƒé¢è·é›¢ (ç•¥)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = EARTH_RADIUS_M; 
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // æ–°å¢ï¼šå°‡ m/s è½‰æ›ç‚ºé¸å®šå–®ä½çš„é€Ÿåº¦
        function convertSpeed(speed_m_s, unit) {
            const factor = CONVERSION_FACTORS[unit] || CONVERSION_FACTORS['km/h']; // é è¨­ km/h
            return speed_m_s * factor;
        }
        
        // ç²å–ç•¶å‰é¸å®šçš„å–®ä½
        function getSelectedUnit() {
            return document.querySelector('input[name="speed_unit"]:checked').value;
        }

        // ç•¶å–®ä½è¢«åˆ‡æ›æ™‚ï¼Œå¼·åˆ¶é‡æ–°é¡¯ç¤ºç•¶å‰é€Ÿåº¦ (å¦‚æœæ­£åœ¨è¿½è¹¤)
        function updateDisplayUnit() {
            if (watchID !== undefined && lastPosition) {
                 // é‡æ–°å‘¼å« success å‡½å¼ï¼Œä½†ä½¿ç”¨ç·©å­˜çš„ lastPosition é€²è¡Œé¡¯ç¤ºæ›´æ–°
                 // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘éœ€è¦ä¸€å€‹æ©Ÿåˆ¶ä¾†åƒ…æ›´æ–°é¡¯ç¤ºï¼Œè€Œä¸è§¸ç™¼æ–°çš„è¨ˆç®—æˆ– watchPosition
                 
                 // ç”±æ–¼æˆ‘å€‘åªç”¨ smoothedSpeed_m_s å„²å­˜ m/sï¼Œæ‰€ä»¥åªéœ€æ›´æ–°é¡¯ç¤ºå³å¯
                 const currentUnit = getSelectedUnit();
                 const speed_kmh = convertSpeed(smoothedSpeed_m_s, currentUnit);

                 const speedDisplay = document.querySelector('.speed-display');
                 speedDisplay.textContent = `${speed_kmh.toFixed(1)} ${currentUnit}`;
            }
        }
        
        // æ ¸å¿ƒé‚è¼¯ï¼šæˆåŠŸç²å–ä½ç½®æ™‚åŸ·è¡Œ
        function success(position) {
            const currentPosition = position;
            const currentUnit = getSelectedUnit();
            let calculatedSpeed_m_s = 0;
            let speedSource = "è¨ˆç®—å€¼ (Haversine)";

            // 1. & 2. è¨ˆç®—åŸå§‹é€Ÿåº¦ (calculatedSpeed_m_s) (é‚è¼¯èˆ‡ V3 ç›¸åŒ)
            if (currentPosition.coords.speed !== null && currentPosition.coords.speed >= 0) {
                calculatedSpeed_m_s = currentPosition.coords.speed;
                speedSource = "å…§å»ºå€¼ (è£ç½® GPS)";
            } 
            else if (lastPosition) {
                const distance = getDistance(
                    lastPosition.coords.latitude, lastPosition.coords.longitude,
                    currentPosition.coords.latitude, currentPosition.coords.longitude
                );
                const timeDiff_s = (currentPosition.timestamp - lastPosition.timestamp) / 1000;
                if (timeDiff_s > 0.5) {
                    calculatedSpeed_m_s = distance / timeDiff_s;
                }
            }

            const calculatedSpeed_kmh = calculatedSpeed_m_s * 3.6; // å§‹çµ‚ä½¿ç”¨ km/h é€²è¡Œåˆ¤æ–·
            
            let smoothingAlpha = SMOOTHING_FACTOR;
            let displayClass = "";
            let statusLight = "ğŸ”´";

            // ===========================================
            // 3. æ¥µç«¯åŒ–é€Ÿåº¦åˆ¤æ–·èˆ‡å¹³æ»‘é‚è¼¯ (V3 é‚è¼¯)
            // ===========================================
            if (calculatedSpeed_kmh <= ZERO_THRESHOLD_KMH) {
                // æ¥µä½é€Ÿ -> å¼·åˆ¶æ­¸é›¶
                smoothedSpeed_m_s = 0;
                displayClass = "stopped";
                statusLight = "ğŸŸ¢";
            } else {
                if (calculatedSpeed_kmh <= HIGH_SPEED_THRESHOLD_KMH) {
                     // éæ¸¡å€é–“
                     smoothingAlpha = SMOOTHING_FACTOR_LOW; 
                } else {
                    // å¿«é€Ÿç§»å‹•
                    smoothingAlpha = SMOOTHING_FACTOR;
                }

                // é€²è¡ŒæŒ‡æ•¸åŠ æ¬Šå¹³æ»‘è™•ç†
                smoothedSpeed_m_s = (smoothingAlpha * calculatedSpeed_m_s) + 
                                    ((1 - smoothingAlpha) * smoothedSpeed_m_s);
            }
            // ===========================================

            // 4. æ›´æ–°ä»‹é¢å…ƒç´  (ä½¿ç”¨é¸å®šçš„å–®ä½)
            const speed_display_value = convertSpeed(smoothedSpeed_m_s, currentUnit);
            const calculated_display_value = convertSpeed(calculatedSpeed_m_s, currentUnit);

            const speedDisplay = document.querySelector('.speed-display');
            speedDisplay.textContent = `${speed_display_value.toFixed(1)} ${currentUnit}`;
            speedDisplay.className = `speed-display ${displayClass}`;

            document.getElementById('status-light').textContent = statusLight;
            document.getElementById('calc-speed').textContent = `${calculated_display_value.toFixed(1)} ${currentUnit} (Î±:${smoothingAlpha.toFixed(2)})`;
            document.getElementById('accuracy-value').textContent = `${currentPosition.coords.accuracy.toFixed(1)} å…¬å°º`;
            document.getElementById('source-value').textContent = speedSource;
            document.getElementById('location-value').textContent = `${currentPosition.coords.latitude.toFixed(4)}, ${currentPosition.coords.longitude.toFixed(4)}`;
            
            // 5. æ›´æ–°ä¸Šä¸€ç­†è³‡æ–™
            lastPosition = currentPosition;
        }

        // éŒ¯èª¤è™•ç† (ç•¥)
        function error(err) {
            let errorMessage;
            switch(err.code) {
                case err.PERMISSION_DENIED: errorMessage = "æ‹’çµ•æˆæ¬Š (è«‹å…è¨±å­˜å–)"; break;
                case err.POSITION_UNAVAILABLE: errorMessage = "è¨Šè™Ÿä¸å¯ç”¨"; break;
                case err.TIMEOUT: errorMessage = "å®šä½è¶…æ™‚"; break;
                default: errorMessage = "æœªçŸ¥éŒ¯èª¤";
            }
            document.querySelector('.speed-display').textContent = "ERROR";
            document.getElementById('status-light').textContent = "âŒ";
            document.getElementById('source-value').textContent = errorMessage;
            stopTracking();
        }

        // é–‹å§‹æŒçºŒè¿½è¹¤
        function startTracking() {
            if (!navigator.geolocation) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½ APIã€‚");
                return;
            }

            document.getElementById("startBtn").disabled = true;
            document.getElementById("stopBtn").disabled = false;

            document.querySelector('.speed-display').textContent = "å®šä½ä¸­...";
            document.getElementById('status-light').textContent = "";
            document.getElementById('calc-speed').textContent = "--.- km/h";
            document.getElementById('accuracy-value').textContent = "--.- å…¬å°º";
            document.getElementById('source-value').textContent = "ç­‰å¾…è¨Šè™Ÿ...";
            document.getElementById('location-value').textContent = "N/A";

            lastPosition = null; 
            smoothedSpeed_m_s = 0; 

            watchID = navigator.geolocation.watchPosition(success, error, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }

        // åœæ­¢æŒçºŒè¿½è¹¤
        function stopTracking() {
            if (watchID !== undefined) {
                navigator.geolocation.clearWatch(watchID);
                watchID = undefined;
                document.getElementById("startBtn").disabled = false;
                document.getElementById("stopBtn").disabled = true;

                document.querySelector('.speed-display').textContent = "å·²åœæ­¢";
                document.getElementById('status-light').textContent = "â¸ï¸";
            }
        }
    </script>

</body>
</html>
